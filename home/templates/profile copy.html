{% extends 'base.html' %}

{% block title %}Profile - MyStore{% endblock %}

{% block content %}
<div class="row" id="profile">
    <div class="col-12">
        <h2 class="mb-4">User Profile</h2>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-person-circle" style="font-size: 6rem; color: #6c757d;"></i>
                <h4 class="mt-3" id="profile-name">Loading...</h4>
                <p class="text-muted" id="profile-email">Loading...</p>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal">Edit Profile</button>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Profile Information</h5>
                <div id="profile-info">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>First Name:</strong></label>
                            <p id="info-first-name">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Last Name:</strong></label>
                            <p id="info-last-name">-</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Email:</strong></label>
                        <p id="info-email">-</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Phone:</strong></label>
                        <p id="info-phone">-</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Address:</strong></label>
                        <p id="info-address">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="edit-error-message" class="alert alert-danger d-none"></div>
                <div id="edit-success-message" class="alert alert-success d-none"></div>
                <form id="edit-profile-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit-first-name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit-last-name">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="edit-phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" rows="2" id="edit-address"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Check if user is logged in
const token = localStorage.getItem('access_token');
if (!token) {
    window.location.href = "{% url 'login' %}";
}

// Load profile data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
});

async function loadProfile() {
    try {
        const response = await fetch('http://127.0.0.1:8000/api/profile/', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            const data = await response.json();
            console.log('Profile data:', data);
            
            // Update profile card
            document.getElementById('profile-name').textContent = `${data.first_name} ${data.last_name}`;
            document.getElementById('profile-email').textContent = data.email;
            
            // Update profile info
            document.getElementById('info-first-name').textContent = data.first_name || '-';
            document.getElementById('info-last-name').textContent = data.last_name || '-';
            document.getElementById('info-email').textContent = data.email || '-';
            document.getElementById('info-phone').textContent = data.phone || '-';
            document.getElementById('info-address').textContent = data.address || '-';
            
            // Populate edit form
            document.getElementById('edit-first-name').value = data.first_name || '';
            document.getElementById('edit-last-name').value = data.last_name || '';
            document.getElementById('edit-phone').value = data.phone || '';
            document.getElementById('edit-address').value = data.address || '';
        } else if (response.status === 401) {
            // Token expired, redirect to login
            localStorage.clear();
            window.location.href = "{% url 'login' %}";
        } else {
            console.error('Failed to load profile');
        }
    } catch (error) {
        console.error('Error loading profile:', error);
    }
}

// Handle profile edit form submission
document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        first_name: document.getElementById('edit-first-name').value,
        last_name: document.getElementById('edit-last-name').value,
        phone: document.getElementById('edit-phone').value,
        address: document.getElementById('edit-address').value,
    };
    
    const errorDiv = document.getElementById('edit-error-message');
    const successDiv = document.getElementById('edit-success-message');
    
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');
    
    try {
        const response = await fetch('http://127.0.0.1:8000/api/profile/', {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            successDiv.textContent = 'Profile updated successfully!';
            successDiv.classList.remove('d-none');
            
            // Update localStorage
            localStorage.setItem('user_name', data.user.first_name);
            
            // Reload profile data
            setTimeout(() => {
                loadProfile();
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                successDiv.classList.add('d-none');
            }, 1500);
        } else {
            errorDiv.textContent = 'Failed to update profile';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        errorDiv.textContent = 'An error occurred';
        errorDiv.classList.remove('d-none');
    }
});
</script>
{% endblock %}